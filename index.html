<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quiz dla Par - Bezpieczny Link</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
    }
    p, li {
      line-height: 1.6;
    }
    button {
      background: #007BFF;
      border: none;
      padding: 10px 20px;
      color: #fff;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 15px;
    }
    button:hover {
      background: #0056b3;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-top: 10px;
    }
    input[type="text"],
    input[type="number"] {
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    fieldset {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    legend {
      font-weight: bold;
    }
    .link-box {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      word-break: break-all;
    }
    @media (max-width: 600px) {
      .container {
        padding: 10px;
        margin: 10px;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Treść generowana przez JavaScript -->
  </div>

  <script>
    // Funkcja pomocnicza: pobiera parametr z URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Funkcja generująca unikalny token
    function generateToken() {
      return Math.random().toString(36).substr(2, 8);
    }

    // Zwraca klucz do localStorage dla danego tokenu
    function sessionKey(token) {
      return 'quizSession_' + token;
    }

    /* Struktura quizu – 5 kategorii z 10 pytaniami każda */
    const quizData = [
      {
        category: "Życie codzienne",
        questions: [
          { id: "codzienne1", text: "Jak oceniasz codzienną komunikację między Wami?" },
          { id: "codzienne2", text: "Jak satysfakcjonujące są Wasze wspólne rutyny?" },
          { id: "codzienne3", text: "Jak dobrze udaje się Wam rozwiązywać codzienne problemy?" },
          { id: "codzienne4", text: "Jak często czujesz, że partner jest obecny emocjonalnie?" },
          { id: "codzienne5", text: "Jak dobrze partner radzi sobie z codziennymi obowiązkami?" },
          { id: "codzienne6", text: "Jak bardzo cenisz drobne gesty w codziennym życiu?" },
          { id: "codzienne7", text: "Jak bardzo czujesz, że Twoje potrzeby są rozumiane na co dzień?" },
          { id: "codzienne8", text: "Jak satysfakcjonujące są wspólne posiłki i gotowanie razem?" },
          { id: "codzienne9", text: "Jak bardzo doceniasz partnera za wsparcie w codziennych wyzwaniach?" },
          { id: "codzienne10", text: "Jak komfortowo czujesz się w dzieleniu codziennych obowiązków?" }
        ]
      },
      {
        category: "Wyznania",
        questions: [
          { id: "wyznania1", text: "Jak szczery jesteś w wyrażaniu swoich uczuć wobec partnera?" },
          { id: "wyznania2", text: "Jak często dzielisz się swoimi marzeniami i obawami?" },
          { id: "wyznania3", text: "Jak bardzo czujesz się swobodnie, wyznając swoje słabości partnerowi?" },
          { id: "wyznania4", text: "Jak otwarcie mówicie o swoich emocjach, nawet tych trudnych?" },
          { id: "wyznania5", text: "Jak dużo wspólnych sekretów jesteście w stanie zachować między sobą?" },
          { id: "wyznania6", text: "Jak często mówicie partnerowi o tym, co naprawdę czujecie?" },
          { id: "wyznania7", text: "Jak ważne są dla Ciebie szczere wyznania w budowaniu relacji?" },
          { id: "wyznania8", text: "Jak radzicie sobie z trudnymi tematami w rozmowach?" },
          { id: "wyznania9", text: "Jak dużą wagę przywiązujesz do wzajemnego zaufania?" },
          { id: "wyznania10", text: "Jak komfortowo dzielisz się swoimi osobistymi przeżyciami?" }
        ]
      },
      {
        category: "Wspomnienia",
        questions: [
          { id: "wspomnienia1", text: "Jak ważne są dla Ciebie wspólne wspomnienia z przeszłości?" },
          { id: "wspomnienia2", text: "Jak często przypominacie sobie miłe chwile razem?" },
          { id: "wspomnienia3", text: "Jak cenisz sobie wspólne świętowanie ważnych momentów?" },
          { id: "wspomnienia4", text: "Jak bardzo budują dla Ciebie wspólne doświadczenia Waszą relację?" },
          { id: "wspomnienia5", text: "Jak bardzo pamiętasz detale z Waszych pierwszych spotkań?" },
          { id: "wspomnienia6", text: "Jak ważne są dla Ciebie tradycje, które razem stworzyliście?" },
          { id: "wspomnienia7", text: "Jak bardzo doceniasz wspólne podróże i przygody?" },
          { id: "wspomnienia8", text: "Jak często wracacie myślami do wspólnie spędzonego czasu?" },
          { id: "wspomnienia9", text: "Jak ważna jest dla Ciebie historia Waszej relacji?" },
          { id: "wspomnienia10", text: "Jak bardzo budujesz na przeszłych doświadczeniach Waszą przyszłość?" }
        ]
      },
      {
        category: "Plany na przyszłość",
        questions: [
          { id: "przyszlosc1", text: "Jak bardzo czujesz, że macie wspólne cele na przyszłość?" },
          { id: "przyszlosc2", text: "Jak jasno wyobrażasz sobie wspólną przyszłość?" },
          { id: "przyszlosc3", text: "Jak często rozmawiacie o marzeniach i planach na przyszłość?" },
          { id: "przyszlosc4", text: "Jak ważne jest dla Ciebie planowanie wspólnej przyszłości?" },
          { id: "przyszlosc5", text: "Jak bardzo jesteś gotów/gotowa na kompromisy dla dobra związku?" },
          { id: "przyszlosc6", text: "Jak oceniasz zdolność do wspólnego pokonywania przyszłych wyzwań?" },
          { id: "przyszlosc7", text: "Jak bardzo cenisz sobie wizję wspólnego rozwoju osobistego?" },
          { id: "przyszlosc8", text: "Jak ważne są dla Ciebie plany dotyczące rodziny i domu?" },
          { id: "przyszlosc9", text: "Jak pewnie czujesz, że Wasza przyszłość będzie stabilna?" },
          { id: "przyszlosc10", text: "Jak dużo energii wkładacie w budowanie wspólnej przyszłości?" }
        ]
      },
      {
        category: "Intymność",
        questions: [
          { id: "intymnosc1", text: "Jak bardzo czujesz się zrozumiany/a na poziomie emocjonalnym?" },
          { id: "intymnosc2", text: "Jak satysfakcjonująca jest dla Ciebie fizyczna bliskość?" },
          { id: "intymnosc3", text: "Jak komfortowo dzielisz się swoimi potrzebami intymnymi?" },
          { id: "intymnosc4", text: "Jak ważne jest dla Ciebie budowanie intymności w związku?" },
          { id: "intymnosc5", text: "Jak dobrze rozumiesz sygnały swojego partnera w sferze intymności?" },
          { id: "intymnosc6", text: "Jak otwarcie mówicie o swoich oczekiwaniach intymnych?" },
          { id: "intymnosc7", text: "Jak satysfakcjonujące są Wasze wspólne chwile intymności?" },
          { id: "intymnosc8", text: "Jak bardzo cenisz sobie intymność jako fundament relacji?" },
          { id: "intymnosc9", text: "Jak dobrze radzicie sobie z rozmawianiem o granicach intymności?" },
          { id: "intymnosc10", text: "Jak silne jest dla Ciebie uczucie bliskości w Waszym związku?" }
        ]
      }
    ];

    const appDiv = document.getElementById('app');

    // Zapis sesji w localStorage
    function saveSession(token, sessionData) {
      localStorage.setItem(sessionKey(token), JSON.stringify(sessionData));
    }

    // Odczyt sesji z localStorage
    function loadSession(token) {
      const data = localStorage.getItem(sessionKey(token));
      return data ? JSON.parse(data) : null;
    }

    // Strona tworzenia nowego quizu – wpisujemy imiona obu partnerów
    function showCreateQuiz() {
      appDiv.innerHTML = `
        <h1>Utwórz Quiz dla Par</h1>
        <p>Wprowadź imiona obu partnerów, aby wygenerować bezpieczny link do quizu.</p>
        <form id="createQuizForm">
          <label for="partner1Name">Imię Partnera 1:</label>
          <input type="text" id="partner1Name" name="partner1Name" required>
          <label for="partner2Name">Imię Partnera 2:</label>
          <input type="text" id="partner2Name" name="partner2Name" required>
          <button type="submit">Utwórz Quiz</button>
        </form>
      `;
      document.getElementById('createQuizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const partner1Name = e.target.partner1Name.value.trim();
        const partner2Name = e.target.partner2Name.value.trim();
        if (!partner1Name || !partner2Name) {
          alert("Proszę wpisać imiona obu partnerów.");
          return;
        }
        const token = generateToken();
        const sessionData = {
          token: token,
          partner1Name: partner1Name,
          partner2Name: partner2Name,
          answers: {}
        };
        saveSession(token, sessionData);
        // Po utworzeniu quizu wyświetlamy linki do udostępnienia
        const baseUrl = window.location.origin + window.location.pathname;
        appDiv.innerHTML = `
          <h2>Quiz został utworzony!</h2>
          <p>Udostępnij poniższe linki odpowiednim osobom:</p>
          <p><strong>${partner1Name}:</strong></p>
          <div class="link-box">${baseUrl}?token=${token}&partner=1</div>
          <p><strong>${partner2Name}:</strong></p>
          <div class="link-box">${baseUrl}?token=${token}&partner=2</div>
          <button id="newQuizBtn">Utwórz nowy quiz</button>
        `;
        document.getElementById('newQuizBtn').addEventListener('click', () => {
          window.location.href = baseUrl;
        });
      });
    }

    // Formularz quizu – partner odpowiada na 50 pytań pogrupowanych po kategoriach
    function showQuizForm(sessionData, partnerNum) {
      const partnerName = partnerNum === "1" ? sessionData.partner1Name : sessionData.partner2Name;
      let formHtml = `<h2>Quiz dla ${partnerName}</h2>
        <p>Odpowiedz na poniższe pytania (skala 1-10):</p>
        <form id="quizForm">`;
      quizData.forEach(category => {
        formHtml += `<fieldset>
          <legend>${category.category}</legend>`;
        category.questions.forEach(q => {
          formHtml += `
            <label for="${q.id}">${q.text}</label>
            <input type="number" id="${q.id}" name="${q.id}" min="1" max="10" required>
          `;
        });
        formHtml += `</fieldset>`;
      });
      formHtml += `<button type="submit">Zapisz odpowiedzi</button></form>`;
      appDiv.innerHTML = formHtml;

      document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        let answers = {};
        quizData.forEach(category => {
          category.questions.forEach(q => {
            answers[q.id] = formData.get(q.id);
          });
        });
        sessionData.answers["partner" + partnerNum] = answers;
        saveSession(sessionData.token, sessionData);
        if (sessionData.answers.partner1 && sessionData.answers.partner2) {
          showResults(sessionData);
        } else {
          appDiv.innerHTML = `<p>Dziękujemy, ${partnerName}. Twoje odpowiedzi zostały zapisane. Czekamy na odpowiedzi drugiego partnera.</p>
          <button id="backBtn">Powrót</button>`;
          document.getElementById('backBtn').addEventListener('click', () => location.reload());
        }
      });
    }

    // Wyliczanie i wyświetlanie wyników – ogólna zgodność oraz wyniki dla każdej kategorii
    function showResults(sessionData) {
      const answers1 = sessionData.answers.partner1;
      const answers2 = sessionData.answers.partner2;
      let totalDifference = 0;
      let totalQuestions = 0;
      let categoryResultsHtml = "";
      quizData.forEach(category => {
        let catDifference = 0;
        const catQuestions = category.questions.length;
        category.questions.forEach(q => {
          const a1 = parseInt(answers1[q.id], 10);
          const a2 = parseInt(answers2[q.id], 10);
          catDifference += Math.abs(a1 - a2);
        });
        totalDifference += catDifference;
        totalQuestions += catQuestions;
        const maxDiffCat = catQuestions * 9; // maksymalna różnica dla kategorii (przy skali 1-10)
        const similarityCat = 100 - ((catDifference / maxDiffCat) * 100);
        categoryResultsHtml += `<li><strong>${category.category}:</strong> Zgodność: ${similarityCat.toFixed(2)}%</li>`;
      });
      const overallMax = totalQuestions * 9;
      const overallSimilarity = 100 - ((totalDifference / overallMax) * 100);

      appDiv.innerHTML = `
        <h2>Wyniki Quizu</h2>
        <p><strong>${sessionData.partner1Name}</strong> vs <strong>${sessionData.partner2Name}</strong></p>
        <p>Ogólna zgodność: <strong>${overallSimilarity.toFixed(2)}%</strong></p>
        <h3>Szczegółowe wyniki według kategorii:</h3>
        <ul>${categoryResultsHtml}</ul>
        <button id="resetBtn">Resetuj Quiz</button>
      `;
      document.getElementById('resetBtn').addEventListener('click', function() {
        localStorage.removeItem(sessionKey(sessionData.token));
        window.location.href = window.location.origin + window.location.pathname;
      });
    }

    // Główna logika – sprawdzamy, czy w URL są parametry token (sesji) oraz partner
    (function() {
      const token = getQueryParam('token');
      const partner = getQueryParam('partner');
      if (token) {
        const sessionData = loadSession(token);
        if (!sessionData) {
          appDiv.innerHTML = `<p>Błąd: Nie znaleziono sesji quizu. Upewnij się, że link jest poprawny.</p>`;
          return;
        }
        if (!partner) {
          appDiv.innerHTML = `<p>Błąd: Brak informacji o partnerze. Użyj linku z parametrem 'partner'.</p>`;
          return;
        }
        showQuizForm(sessionData, partner);
      } else {
        showCreateQuiz();
      }
    })();
  </script>
</body>
</html>
